// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  firstName   String?
  lastName    String?
  name        String
  email       String   @unique
  username    String   @unique @default(cuid())
  password    String
  roleId      String?
  role        Role?    @relation(fields: [roleId], references: [id])
  status      String   @default("Active")
  lastLogin   String?
  permissions String[] // Granular overrides if needed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Finance Officer"
  permissions Json     // Granular permissions per module
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Student {
  id              String        @id @default(cuid())
  admissionNumber String        @unique
  firstName       String
  lastName        String
  gender          String
  grade           String
  dateOfBirth     String?
  parentName      String
  parentPhone     String
  parentEmail     String?
  address         String?
  status          String        @default("Active")
  enrollmentDate  String
  totalFees       Float         @default(0)
  paidFees        Float         @default(0)
  feeBalance      Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  attendance      Attendance[]
  payments        Payment[]
  results         Result[]
  assessmentScores AssessmentScore[]
}

model Teacher {
  id              String   @id @default(cuid())
  firstName       String
  lastName        String
  email           String   @unique
  phone           String
  qualification   String?
  subjects        String[] // stored as array
  grades          String[] // stored as array
  status          String   @default("Active")
  joinDate        String
  maxLessonsDay   Int      @default(8)
  maxLessonsWeek  Int      @default(40)
  availability    Json?    // Specific days/times teacher is available
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Attendance {
  id          String   @id @default(cuid())
  studentId   String
  studentName String
  grade       String
  date        String
  status      String   // Present, Absent, Late, Excused
  createdAt   DateTime @default(now())
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
}

model Exam {
  id         String   @id @default(cuid())
  name       String
  subject    String
  grade      String
  date       String
  type       String   // Midterm, Final, Quiz, Assignment
  term       String
  status     String   @default("Scheduled")
  totalMarks Int      @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Payment {
  id            String   @id @default(cuid())
  studentId     String
  studentName   String
  grade         String
  amount        Float
  method        String   // Cash, M-Pesa, Bank Transfer, Cheque
  reference     String?
  date          String
  term          String
  receiptNumber String   @unique
  createdAt     DateTime @default(now())
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model TimetableEntry {
  id          String   @id @default(cuid())
  grade       String
  day         String
  timeSlot    String   // Keep for backward compatibility/display
  slotId      String?  // New field linking to TimeSlot
  subject     String
  teacherId   String?
  teacherName String
  createdAt   DateTime @default(now())

  @@unique([grade, day, timeSlot])
}

model Settings {
  id                   String     @id @default(cuid())
  schoolName           String     @default("School management system")
  motto                String     @default("Excellence in Education")
  phone                String     @default("+254 700 000 000")
  telephone            String?
  email                String     @default("info@elirama.ac.ke")
  address              String     @default("Nairobi, Kenya")
  poBox                String?
  currentTerm          String     @default("Term 1")
  currentYear          Int        @default(2026)
  logo                         String?    // Base64 or URL
  paybillNumber                String?
  headteacherSignature         String?    // Base64 or URL
  financeSignature             String?    // Base64 or URL
  earlyYearsEnabled            Boolean    @default(true) // PlayGroup, PP1, PP2
  primaryEnabled               Boolean    @default(true)
  jssEnabled                   Boolean    @default(false)
  sssEnabled                   Boolean    @default(false)
  autoTimetableEnabled         Boolean    @default(false)
  manualTimetableBuilderEnabled Boolean    @default(true)
  updatedAt                    DateTime   @updatedAt
  timeSlots            TimeSlot[]
}

model TimeSlot {
  id         String   @id @default(cuid())
  label      String
  startTime  String?  // e.g. "08:00"
  endTime    String?  // e.g. "08:40"
  type       String   @default("Lesson") // Lesson, Break, Lunch, Assembly, Other
  order      Int      @default(0)
  isActive   Boolean  @default(true)
  settings   Settings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  settingsId String
}

model Result {
  id          String   @id @default(cuid())
  studentId   String
  studentName String
  examId      String
  subject     String
  marks       Float
  level       String   // EE, ME, AE, BE
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId, subject])
}

model SyncStatus {
  id           String   @id @default("global")
  lastUpdated  DateTime @default(now()) @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  userName   String
  userRole   String?
  action     String
  module     String?
  details    String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  deviceInfo String?
  createdAt  DateTime @default(now())
}

model FeeStructure {
  id        String   @id @default(cuid())
  grade     String
  name      String   // e.g., "Tuition", "Lunch", "Transport"
  amount    Float
  term      String
  status    String   @default("Draft") // Draft, Published
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LearningArea {
  id        String   @id @default(cuid())
  name      String   // e.g., "Mathematics"
  grade     String   // e.g., "Grade 1"
  strands   Strand[]
  createdAt DateTime @default(now())
}

model Strand {
  id              String         @id @default(cuid())
  name            String         // e.g., "Numbers"
  learningArea    LearningArea   @relation(fields: [learningAreaId], references: [id], onDelete: Cascade)
  learningAreaId  String
  subStrands      SubStrand[]
  createdAt       DateTime       @default(now())
}

model SubStrand {
  id        String   @id @default(cuid())
  name      String   // e.g., "Counting"
  strand    Strand   @relation(fields: [strandId], references: [id], onDelete: Cascade)
  strandId  String
  assessments AssessmentItem[]
  createdAt DateTime @default(now())
}

model AssessmentItem {
  id          String   @id @default(cuid())
  name        String   // e.g., "Class Project 1"
  type        String   // Formative, Summative, Project
  weight      Float    @default(1.0)
  subStrand   SubStrand @relation(fields: [subStrandId], references: [id], onDelete: Cascade)
  subStrandId String
  scores      AssessmentScore[]
  createdAt   DateTime @default(now())
}

model AssessmentScore {
  id               String         @id @default(cuid())
  studentId        String
  assessmentItemId String
  score            Float?         // Percentage or Raw
  level            String?        // EE, ME, AE, BE
  remarks          String?
  assessmentItem   AssessmentItem @relation(fields: [assessmentItemId], references: [id], onDelete: Cascade)
  student          Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdAt        DateTime       @default(now())

  @@unique([studentId, assessmentItemId])
}

model Account {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "1001"
  name        String   // e.g., "Cash at Bank"
  type        String   // ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  category    String   // e.g., "Current Asset", "Tuition Income"
  balance     Float    @default(0)
  isSystem    Boolean  @default(false)
  entries     JournalEntry[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JournalEntry {
  id            String   @id @default(cuid())
  transactionId String   // Group multiple entries into one transaction
  accountId     String
  description   String
  debit         Float    @default(0)
  credit        Float    @default(0)
  reference     String?  // e.g., Receipt No or Expense ID
  date          DateTime @default(now())
  account       Account  @relation(fields: [accountId], references: [id])
  createdAt     DateTime @default(now())
}

model ExpenseRequest {
  id                String   @id @default(cuid())
  category          String   // e.g., "Utilities", "Maintenance"
  description       String
  department        String?
  amount            Float
  supportingDoc     String?  // URL/Base64
  status            String   @default("Draft") // Draft, Pending, Approved, Paid, Rejected
  requestedById     String
  requestedByName   String
  approvedById      String?
  approvedByName    String?
  paidAt            DateTime?
  journalPosted     Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Staff {
  id             String   @id @default(cuid())
  firstName      String
  lastName       String
  type           String   // BOM_TEACHER, SUPPORT_STAFF
  role           String?
  email          String?  @unique
  phone          String?
  salaryType     String   @default("Fixed") // Fixed, Hourly
  basicSalary    Float    @default(0)
  allowances     Json?    // Array of { name, amount }
  deductions     Json?    // Array of { name, amount }
  bankName       String?
  accountNumber  String?
  status         String   @default("Active")
  payrollEntries PayrollEntry[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PayrollEntry {
  id            String   @id @default(cuid())
  staffId       String
  month         Int      // 1-12
  year          Int
  basicSalary   Float
  totalAllowances Float @default(0)
  totalDeductions Float @default(0)
  netPay        Float
  status        String   @default("Draft") // Draft, Reviewed, Approved, Locked
  payslipUrl    String?
  staff         Staff    @relation(fields: [staffId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([staffId, month, year])
}

model Budget {
  id             String   @id @default(cuid())
  year           Int
  term           String?
  department     String
  category       String
  allocatedAmount Float
  spentAmount     Float    @default(0)
  utilization    Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([year, term, department, category])
}
