// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  firstName   String?
  lastName    String?
  name        String
  email       String   @unique
  username    String   @unique @default(cuid())
  password    String
  roleId      String?
  role        Role?    @relation(fields: [roleId], references: [id])
  status      String   @default("Active")
  lastLogin   String?
  permissions String[] // Granular overrides if needed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Finance Officer"
  permissions Json     // Granular permissions per module
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Student {
  id              String        @id @default(cuid())
  admissionNumber String        @unique
  firstName       String
  lastName        String
  gender          String
  grade           String
  dateOfBirth     String?
  parentName      String
  parentPhone     String
  parentEmail     String?
  address         String?
  status          String        @default("Active")
  enrollmentDate  String
  totalFees       Float         @default(0)
  paidFees        Float         @default(0)
  feeBalance      Float         @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  attendance      Attendance[]
  payments        Payment[]
  results         Result[]
}

model Teacher {
  id            String   @id @default(cuid())
  firstName     String
  lastName      String
  email         String   @unique
  phone         String
  qualification String?
  subjects      String[] // stored as array
  grades        String[] // stored as array
  status        String   @default("Active")
  joinDate      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Attendance {
  id          String   @id @default(cuid())
  studentId   String
  studentName String
  grade       String
  date        String
  status      String   // Present, Absent, Late, Excused
  createdAt   DateTime @default(now())
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date])
}

model Exam {
  id         String   @id @default(cuid())
  name       String
  subject    String
  grade      String
  date       String
  type       String   // Midterm, Final, Quiz, Assignment
  term       String
  status     String   @default("Scheduled")
  totalMarks Int      @default(100)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Payment {
  id            String   @id @default(cuid())
  studentId     String
  studentName   String
  grade         String
  amount        Float
  method        String   // Cash, M-Pesa, Bank Transfer, Cheque
  reference     String?
  date          String
  term          String
  receiptNumber String   @unique
  createdAt     DateTime @default(now())
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model TimetableEntry {
  id          String   @id @default(cuid())
  grade       String
  day         String
  timeSlot    String   // Keep for backward compatibility/display
  slotId      String?  // New field linking to TimeSlot
  subject     String
  teacherId   String?
  teacherName String
  createdAt   DateTime @default(now())

  @@unique([grade, day, timeSlot])
}

model Settings {
  id                   String     @id @default(cuid())
  schoolName           String     @default("ELIRAMA SCHOOL")
  motto                String     @default("Excellence in Education")
  phone                String     @default("+254 700 000 000")
  telephone            String?
  email                String     @default("info@elirama.ac.ke")
  address              String     @default("Nairobi, Kenya")
  poBox                String?
  currentTerm          String     @default("Term 1")
  currentYear          Int        @default(2026)
  logo                 String?    // Base64 or URL
  paybillNumber        String?
  headteacherSignature String?    // Base64 or URL
  financeSignature     String?    // Base64 or URL
  primaryEnabled       Boolean    @default(true)
  jssEnabled           Boolean    @default(false)
  sssEnabled           Boolean    @default(false)
  updatedAt            DateTime   @updatedAt
  timeSlots            TimeSlot[]
}

model TimeSlot {
  id         String   @id @default(cuid())
  label      String
  startTime  String?  // e.g. "08:00"
  endTime    String?  // e.g. "08:40"
  type       String   @default("Lesson") // Lesson, Break, Lunch, Assembly, Other
  order      Int      @default(0)
  isActive   Boolean  @default(true)
  settings   Settings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  settingsId String
}

model Result {
  id          String   @id @default(cuid())
  studentId   String
  studentName String
  examId      String
  subject     String
  marks       Float
  level       String   // EE, ME, AE, BE
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId, subject])
}

model SyncStatus {
  id           String   @id @default("global")
  lastUpdated  DateTime @default(now()) @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  userName  String
  action    String
  details   String
  ipAddress String?
  createdAt DateTime @default(now())
}

model FeeStructure {
  id        String   @id @default(cuid())
  grade     String
  name      String   // e.g., "Tuition", "Lunch", "Transport"
  amount    Float
  term      String
  status    String   @default("Draft") // Draft, Published
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
